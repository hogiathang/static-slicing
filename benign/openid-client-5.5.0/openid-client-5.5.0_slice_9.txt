module.exports = async function request(options, { accessToken, mTLS = false, DPoP } = {}) {
  let url;
  try {
    url = new URL(options.url);
    delete options.url;
    assert(/^(https?:)$/.test(url.protocol));
  } catch (err) {
    throw new TypeError('only valid absolute URLs can be requested');
  }
  const optsFn = this[HTTP_OPTIONS];
  let opts = options;

  const nonceKey = `${url.origin}${url.pathname}`;
  if (DPoP && 'dpopProof' in this) {
    opts.headers = opts.headers || {};
    opts.headers.DPoP = await this.dpopProof(
      {
        htu: `${url.origin}${url.pathname}`,
        htm: options.method,
        nonce: nonces.get(nonceKey),
      },
      DPoP,
      accessToken,
    );
  }

  let userOptions;
  if (optsFn) {
    userOptions = pick(
      optsFn.call(this, url, defaultsDeep({}, opts, DEFAULT_HTTP_OPTIONS)),
      ...allowed,
    );
  }
  opts = defaultsDeep({}, userOptions, opts, DEFAULT_HTTP_OPTIONS);

  if (mTLS && !opts.pfx && !(opts.key && opts.cert)) {...
url = new URL(options.url)
delete options.url
assert(/^(https?:)$/.test(url.protocol))
throw new TypeError('only valid absolute URLs can be requested');
const optsFn = this[HTTP_OPTIONS]
let opts = options
<operator>.formatString("", url.origin, "", url.pathname, "")
DPoP && 'dpopProof' in this
opts.headers = opts.headers || {}
opts.headers.DPoP = await this.dpopProof(
      {
        htu: `${url.origin}${url.pathname}`,
        htm: options.method,
        nonce: nonces.get(nonceKey),
      },
      DPoP,
      accessToken,
    )
_tmp_17.htu = <operator>.formatString("", url.origin, "", url.pathname, "")
_tmp_17.htm = options.method
_tmp_17.nonce = nonces.get(nonceKey)
userOptions = pick(
      optsFn.call(this, url, defaultsDeep({}, opts, DEFAULT_HTTP_OPTIONS)),
      ...allowed,
    )
optsFn.call(this, url, defaultsDeep({}, opts, DEFAULT_HTTP_OPTIONS))
...allowed
opts = defaultsDeep({}, userOptions, opts, DEFAULT_HTTP_OPTIONS)
mTLS && !opts.pfx && !(opts.key && opts.cert)
throw new TypeError('mutual-TLS certificate and key not set');
opts.searchParams
_iterator_0 = <operator>.iterator(Object.entries(opts.searchParams))
(_tmp_21 = url.searchParams).delete
url.searchParams.set(key, value)
