function getValidLine = function getValidLine(options) {
  var res, forceNext, limitMessage,
    matches, histInput, args, resCheck;

  function _getPhContent(param) { return getPhContent(param, options); }
  function addDisplay(text) { options.display += (/[^\r\n]$/.test(options.display) ? '\n' : '') + text; }

  options.limitSrc = options.limit;
  options.displaySrc = options.display;
  options.limit = ''; // for readlineExt
  options.display = replacePlaceholder(options.display + '', _getPhContent);

  while (true) {
    res = _readlineSync(options);
    forceNext = false;
    limitMessage = '';

    if (options.defaultInput && !res) { res = options.defaultInput; }

    if (options.history) {
      if ((matches = /^\s*!(?:!|-1)(:p)?\s*$/.exec(res))) { // `!!` `!-1` +`:p`
        histInput = inputHistory[0] || '';
        if (matches[1]) { // only display
          forceNext = true;
        } else { // replace input
          res = histInput;
        }
        // Show it even if it is empty (NL only).
  ...
function _getPhContent = function _getPhContent(param) { return getPhContent(param, options); }
function addDisplay = function addDisplay(text) { options.display += (/[^\r\n]$/.test(options.display) ? '\n' : '') + text; }
options.limitSrc = options.limit
options.displaySrc = options.display
options.limit = ''
options.display = replacePlaceholder(options.display + '', _getPhContent)
res = _readlineSync(options)
forceNext = false
limitMessage = ''
options.defaultInput && !res
options.history
matches = /^\s*!(?:!|-1)(:p)?\s*$/.exec(res)
histInput = inputHistory[0] || ''
matches[1]
forceNext = true
res = histInput
addDisplay(histInput + '\n')
!forceNext
options.displayOnly = true
_readlineSync(options)
options.displayOnly = false
res && res !== inputHistory[inputHistory.length - 1]
_tmp_65 = __ecma.Array.factory()
!forceNext && options.cd && res
args = parseCl(res)
(_tmp_66 = args[0]).toLowerCase
"cd"
args[1]
process.chdir(replaceHomePath(args[1], true))
addDisplay(e + '')
forceNext = true
break;
"pwd"
addDisplay(process.cwd())
forceNext = true
break;
!forceNext && options.preCheck
resCheck = options.preCheck(res, options)
res = resCheck.res
resCheck.forceNext
!forceNext
!options.limitSrc.length ||
        isMatched(res, options.limitSrc, options.caseSensitive)
isMatched(res, options.limitSrc, options.caseSensitive)
options.limitMessage
limitMessage = replacePlaceholder(options.limitMessage, _getPhContent)
addDisplay((limitMessage ? limitMessage + '\n' : '') +
      replacePlaceholder(options.displaySrc + '', _getPhContent))
replacePlaceholder(options.displaySrc + '', _getPhContent)
