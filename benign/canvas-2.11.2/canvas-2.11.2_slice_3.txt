const query = process.argv[2]
const fs = require('fs')
const childProcess = require('child_process')
const SYSTEM_PATHS = [
  '/lib',
  '/usr/lib',
  '/usr/lib64',
  '/usr/local/lib',
  '/opt/local/lib',
  '/opt/homebrew/lib',
  '/usr/lib/x86_64-linux-gnu',
  '/usr/lib/i386-linux-gnu',
  '/usr/lib/arm-linux-gnueabihf',
  '/usr/lib/arm-linux-gnueabi',
  '/usr/lib/aarch64-linux-gnu'
]
_tmp_2.push("/lib")
_tmp_2.push("/usr/lib")
_tmp_2.push("/usr/lib64")
_tmp_2.push("/usr/local/lib")
_tmp_2.push("/opt/local/lib")
_tmp_2.push("/opt/homebrew/lib")
_tmp_2.push("/usr/lib/x86_64-linux-gnu")
_tmp_2.push("/usr/lib/i386-linux-gnu")
_tmp_2.push("/usr/lib/arm-linux-gnueabihf")
_tmp_2.push("/usr/lib/arm-linux-gnueabi")
_tmp_2.push("/usr/lib/aarch64-linux-gnu")
function hasSystemLib = function hasSystemLib (lib) {
  const libName = 'lib' + lib + '.+(so|dylib)'
  const libNameRegex = new RegExp(libName)

  // Try using ldconfig on linux systems
  if (hasLdconfig()) {
    try {
      if (childProcess.execSync('ldconfig -p 2>/dev/null | grep -E "' + libName + '"').length) {
        return true
      }
    } catch (err) {
      // noop -- proceed to other search methods
    }
  }

  // Try checking common library locations
  return SYSTEM_PATHS.some(function (systemPath) {
    try {
      const dirListing = fs.readdirSync(systemPath)
      return dirListing.some(function (file) {
        return libNameRegex.test(file)
      })
    } catch (err) {
      return false
    }
  })
}
function hasLdconfig = function hasLdconfig () {
  try {
    // Add /sbin to path as ldconfig is located there on some systems -- e.g.
    // Debian (and it can still be used by unprivileged users):
    childProcess.execSync('export PATH="$PATH:/sbin"')
    process.env.PATH = '...'
    // execSync throws on nonzero exit
    childProcess.execSync('hash ldconfig 2>/dev/null')
    return true
  } catch (err) {
    return false
  }
}
function hasFreetype = function hasFreetype () {
  try {
    if (childProcess.execSync('pkg-config cairo --cflags-only-I 2>/dev/null | grep freetype2').length) {
      return true
    }
  } catch (err) {
    // noop
  }
  return false
}
function hasPkgconfigLib = function hasPkgconfigLib (lib) {
  try {
    // execSync throws on nonzero exit
    childProcess.execSync('pkg-config --exists "' + lib + '" 2>/dev/null')
    return true
  } catch (err) {
    return false
  }
}
function main = function main (query) {
  switch (query) {
    case 'gif':
    case 'cairo':
      return hasSystemLib(query)
    case 'pango':
      return hasPkgconfigLib(query)
    case 'freetype':
      return hasFreetype()
    case 'jpeg':
      return hasPkgconfigLib('libjpeg')
    case 'rsvg':
      return hasPkgconfigLib('librsvg-2.0')
    default:
      throw new Error('Unknown library: ' + query)
  }
}
process.stdout.write(main(query).toString())
