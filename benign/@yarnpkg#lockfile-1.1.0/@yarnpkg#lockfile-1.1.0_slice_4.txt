var run = function (reaction) {
      var handler = ok ? reaction.ok : reaction.fail;
      var resolve = reaction.resolve;
      var reject = reaction.reject;
      var domain = reaction.domain;
      var result, then, exited;
      try {
        if (handler) {
          if (!ok) {
            if (promise._h == 2) onHandleUnhandled(promise);
            promise._h = 1;
          }
          if (handler === true) result = value;
          else {
            if (domain) domain.enter();
            result = handler(value); // may throw
            if (domain) {
              domain.exit();
              exited = true;
            }
          }
          if (result === reaction.promise) {
            reject(TypeError('Promise-chain cycle'));
          } else if (then = isThenable(result)) {
            then.call(result, resolve, reject);
          } else resolve(result);
        } else reject(value);
      } catch (e) {
        if (domain && !exited) domain.exit();
        reject(e);
     ...
var handler = ok ? reaction.ok : reaction.fail
var resolve = reaction.resolve
var reject = reaction.reject
var domain = reaction.domain
!ok
onHandleUnhandled(promise)
promise._h = 1
handler === true
domain.enter()
result = handler(value)
domain.exit()
exited = true
result === reaction.promise
reject(TypeError('Promise-chain cycle'))
then = isThenable(result)
then.call(result, resolve, reject)
resolve(result)
reject(value)
domain && !exited
