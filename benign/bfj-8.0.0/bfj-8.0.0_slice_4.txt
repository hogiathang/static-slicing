function parse = function parse (stream, options = {}) {
  const Promise = promise(options)

  try {
    check.assert.maybe.function(options.reviver, 'Invalid reviver option')
  } catch (err) {
    return Promise.reject(err)
  }

  const errors = []
  const scopes = []
  const reviver = options.reviver
  const shouldHandleNdjson = !! options.ndjson

  let emitter, resolve, reject, scopeKey
  if (shouldHandleNdjson && NDJSON_STATE.has(stream)) {
    const state = NDJSON_STATE.get(stream)
    NDJSON_STATE.delete(stream)
    emitter = state.emitter
    setImmediate(state.resume)
  } else {
    emitter = walk(stream, options)
  }

  emitter.on(events.array, array)
  emitter.on(events.object, object)
  emitter.on(events.property, property)
  emitter.on(events.string, value)
  emitter.on(events.number, value)
  emitter.on(events.literal, value)
  emitter.on(events.endArray, endScope)
  emitter.on(events.endObject, endScope)
  emitter.on(events.end, end)
  emitter.on(events.error, error)
  emitter.on(event...
const Promise = promise(options)
check.assert.maybe.function(options.reviver, 'Invalid reviver option')
__ecma.Array.factory()
__ecma.Array.factory()
const reviver = options.reviver
const shouldHandleNdjson = !! options.ndjson
shouldHandleNdjson && NDJSON_STATE.has(stream)
const state = NDJSON_STATE.get(stream)
NDJSON_STATE.delete(stream)
function array = function array () {
    if (errors.length > 0) {
      return
    }

    beginScope([])
  }
function beginScope = function beginScope (parsed) {
    if (errors.length > 0) {
      return
    }

    if (scopes.length > 0) {
      value(parsed)
    }

    scopes.push(parsed)
  }
function value = function value (v) {
    if (errors.length > 0) {
      return
    }

    if (scopes.length === 0) {
      return scopes.push(v)
    }

    const scope = scopes[scopes.length - 1]

    if (scopeKey) {
      scope[scopeKey] = v
      scopeKey = null
    } else {
      scope.push(v)
    }
  }
function object = function object () {
    if (errors.length > 0) {
      return
    }

    beginScope({})
  }
function property = function property (name) {
    if (errors.length > 0) {
      return
    }

    scopeKey = name
  }
function endScope = function endScope () {
    if (errors.length > 0) {
      return
    }

    if (scopes.length > 1) {
      scopes.pop()
    }
  }
function end = function end () {
    if (shouldHandleNdjson) {
      const resume = emitter.pause()
      emitter.removeAllListeners()
      NDJSON_STATE.set(stream, { emitter, resume })
    }

    if (errors.length > 0) {
      return reject(errors[0])
    }

    if (reviver) {
      scopes[0] = transform(scopes[0], '')
    }

    resolve(scopes[0])
  }
function transform = function transform (obj, key) {
    if (obj && typeof obj === 'object') {
      Object.entries(obj).forEach(([ k, v ]) => {
        obj[k] = transform(v, k)
      })
    }

    return reviver(key, obj)
  }
function error = function error (e) {
    errors.push(e)
  }
function endLine = function endLine () {
    if (scopes.length > 0) {
      end()
    }
  }
