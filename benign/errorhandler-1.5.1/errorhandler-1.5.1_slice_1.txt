function errorHandler (err, req, res, next) {
    // respect err.statusCode
    if (err.statusCode) {
      res.statusCode = err.statusCode
    }

    // respect err.status
    if (err.status) {
      res.statusCode = err.status
    }

    // default status code to 500
    if (res.statusCode < 400) {
      res.statusCode = 500
    }

    // log the error
    var str = stringify(err)
    if (log) {
      defer(log, err, str, req, res)
    }

    // cannot actually respond
    if (res._header) {
      return req.socket.destroy()
    }

    // negotiate
    var accept = accepts(req)
    var type = accept.type('html', 'json', 'text')

    // Security header for content sniffing
    res.setHeader('X-Content-Type-Options', 'nosniff')

    // html
    if (type === 'html') {
      var isInspect = !err.stack && String(err) === toString.call(err)
      var errorHtml = !isInspect
        ? escapeHtmlBlock(str.split('\n', 1)[0] || 'Error')
        : 'Error'
      var stack = !isInspect
        ...
err.statusCode
res.statusCode = err.statusCode
err.status
res.statusCode = err.status
res.statusCode < 400
res.statusCode = 500
var str = stringify(err)
defer(log, err, str, req, res)
res._header
var accept = accepts(req)
var type = accept.type('html', 'json', 'text')
res.setHeader('X-Content-Type-Options', 'nosniff')
type === 'html'
type === 'json'
var error = { message: err.message, stack: err.stack }
_iterator_0 = <operator>.iterator(err)
var json = JSON.stringify({ error: error }, null, 2)
